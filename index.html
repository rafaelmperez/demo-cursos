<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Herrera Hoy — Cursos subvencionados</title>

  <style>
    /* ═══════════════════════════════════════════════════════════════
       SISTEMA DE DISEÑO HERRERA HOY - INSTITUCIONAL PREMIUM
       ═══════════════════════════════════════════════════════════════ */
    :root {
      /* Colores institucionales LIGHT */
      --primary: #1E3A8A;
      --primary-dark: #1E40AF;
      --primary-light: #3B82F6;
      
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8FAFC;
      --bg-tertiary: #F1F5F9;
      --bg-elevated: #FFFFFF;
      --bg-overlay: rgba(255, 255, 255, 0.95);
      
      --text-primary: #0F172A;
      --text-secondary: #475569;
      --text-tertiary: #64748B;
      --text-muted: #94A3B8;
      --text-on-primary: #FFFFFF;
      
      --border: #E2E8F0;
      --border-medium: #CBD5E1;
      --border-strong: #94A3B8;
      
      --ok: #16A34A;
      --ok-bg: #DCFCE7;
      --ok-border: #BBF7D0;
      
      --warn: #D97706;
      --warn-bg: #FEF3C7;
      --warn-border: #FDE68A;
      
      --danger: #DC2626;
      --danger-bg: #FEE2E2;
      --danger-border: #FECACA;
      
      --neutral: #64748B;
      --neutral-bg: #F1F5F9;
      --neutral-border: #CBD5E1;
      
      --info: #0284C7;
      --info-bg: #E0F2FE;
      --info-border: #BAE6FD;
      
      /* Espaciado */
      --space-xs: 4px;
      --space-sm: 6px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --space-2xl: 32px;
      --space-3xl: 48px;
      
      /* Tipografía MEJORADA */
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-base: 15px;
      --font-size-lg: 17px;
      --font-size-xl: 19px;
      --font-size-2xl: 22px;
      
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --font-weight-black: 900;
      
      /* Sombras mínimas */
      --shadow-1: 0 1px 2px 0 rgba(0, 0, 0, 0.04);
      --shadow-2: 0 2px 4px 0 rgba(0, 0, 0, 0.06);
      --shadow-3: 0 4px 8px 0 rgba(0, 0, 0, 0.08);
      
      /* Transiciones */
      --transition-subtle: 150ms ease-out;
      --transition-base: 180ms ease-out;
    }

    /* ═══════════════════════════════════════════════════════════════
       DARK MODE
       ═══════════════════════════════════════════════════════════════ */
    body.dark-mode {
      --bg-primary: #0F172A;
      --bg-secondary: #1E293B;
      --bg-tertiary: #334155;
      --bg-elevated: #1E293B;
      --bg-overlay: rgba(15, 23, 42, 0.95);
      
      --text-primary: #F1F5F9;
      --text-secondary: #CBD5E1;
      --text-tertiary: #94A3B8;
      --text-muted: #64748B;
      
      --border: #334155;
      --border-medium: #475569;
      --border-strong: #64748B;
      
      --ok-bg: rgba(22, 163, 74, 0.15);
      --warn-bg: rgba(217, 119, 6, 0.15);
      --danger-bg: rgba(220, 38, 38, 0.15);
      --info-bg: rgba(2, 132, 199, 0.15);
      
      --neutral-bg: rgba(100, 116, 139, 0.15);
      
      --shadow-1: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-2: 0 2px 4px 0 rgba(0, 0, 0, 0.4);
      --shadow-3: 0 4px 8px 0 rgba(0, 0, 0, 0.5);
    }

    /* ═══════════════════════════════════════════════════════════════
       RESET BÁSICO
       ═══════════════════════════════════════════════════════════════ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 15px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color 200ms ease, color 200ms ease;
    }

    /* ═══════════════════════════════════════════════════════════════
       LAYOUT PRINCIPAL
       ═══════════════════════════════════════════════════════════════ */
    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
    }

    /* ═══════════════════════════════════════════════════════════════
       HERO BANNER
       ═══════════════════════════════════════════════════════════════ */
    .hero-banner {
      position: relative;
      width: 100%;
      background: #FFFFFF;
      border: 1px solid var(--border);
      border-top: 1px solid var(--border);
      border-left: 0;
      border-right: 0;
      border-bottom: 0;
      overflow: hidden;
    }

    body.dark-mode .hero-banner {
      background: #FFFFFF;
      border-color: #E5E7EB;
    }

    .hero-image {
      width: 100%;
      height: 138px;
      object-fit: contain;
      object-position: center;
      display: block;
      padding: var(--space-md);
    }

    body.dark-mode .hero-image {
      opacity: 0.92;
      filter: brightness(0.95);
    }

    @media (max-width: 640px) {
      .hero-image { 
        height: 92px;
        padding: var(--space-sm);
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       DARK MODE TOGGLE - CUADRADO
       ═══════════════════════════════════════════════════════════════ */
    .theme-toggle {
      position: fixed;
      top: var(--space-lg);
      right: var(--space-lg);
      z-index: 9999;
      width: 48px;
      height: 48px;
      border-radius: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .theme-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      border-color: var(--border-medium);
    }

    .theme-toggle svg {
      width: 22px;
      height: 22px;
      color: var(--text-primary);
      transition: all var(--transition-base);
    }

    body.dark-mode .theme-toggle {
      background: var(--bg-elevated);
      border-color: var(--border-medium);
    }

    @media (max-width: 640px) {
      .theme-toggle {
        top: var(--space-sm);
        right: var(--space-sm);
        width: 40px;
        height: 40px;
      }
      .theme-toggle svg { width: 18px; height: 18px; }
    }

    /* ═══════════════════════════════════════════════════════════════
       FONDOS EUROPEOS
       ═══════════════════════════════════════════════════════════════ */
    .fondos-section {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: var(--space-lg) var(--space-md);
    }

    .fondos-container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      gap: var(--space-lg);
      align-items: center;
    }

    @media (min-width: 768px) {
      .fondos-container {
        grid-template-columns: 1fr auto;
      }
    }

    .fondos-text {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .fondos-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-black);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin: 0;
    }

    .fondos-desc {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin: 0;
      max-width: 60ch;
      line-height: 1.4;
    }

    .fondos-logos {
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .fondo-logo-ministerio {
      height: 69px;
      width: auto;
      max-width: 100%;
      object-fit: contain;
      transition: opacity var(--transition-subtle);
      background: white;
      padding: 8px 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-1);
    }

    .fondo-logo-ministerio:hover {
      opacity: 0.9;
    }

    body.dark-mode .fondo-logo-ministerio {
      filter: brightness(0.95);
      border-color: #E5E7EB;
    }

    @media (max-width: 768px) {
      .fondos-container {
        grid-template-columns: 1fr;
        gap: var(--space-md);
      }
      
      .fondos-logos {
        justify-content: center;
      }
      
      .fondo-logo-ministerio {
        height: 58px;
        padding: 6px 10px;
      }
    }

    @media (max-width: 640px) {
      .fondos-section { 
        padding: var(--space-md) var(--space-sm); 
      }
      
      .fondos-title {
        font-size: 11px;
        text-align: center;
      }
      
      .fondos-desc {
        font-size: 11px;
        text-align: center;
        max-width: 100%;
      }
      
      .fondo-logo-ministerio {
        height: 51px;
        padding: 6px 8px;
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       MÓDULO PRINCIPAL
       ═══════════════════════════════════════════════════════════════ */
    .module {
      position: relative;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: var(--shadow-2);
      margin: var(--space-xl) var(--space-md);
    }

    @media (max-width: 640px) {
      .module { margin: var(--space-md) var(--space-sm); }
    }

    /* Header */
    .module__top {
      padding: var(--space-lg);
      display: grid;
      gap: var(--space-md);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    @media (min-width: 768px) {
      .module__top {
        grid-template-columns: 1fr auto;
        align-items: start;
      }
    }

    @media (min-width: 1024px) {
      .module__top {
        grid-template-columns: 1fr 520px;
        column-gap: var(--space-xl);
      }
    }

    @media (max-width: 640px) {
      .module__top {
        padding: var(--space-md);
      }
    }

    .titleBlock { min-width: 0; }

    /* ═══════════════════════════════════════════════════════════════
       BRANDLINE PRO
       ═══════════════════════════════════════════════════════════════ */
    .brandline {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-sm);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      min-width: 0;
    }

    .brand-logo {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      padding: 8px;
      box-shadow: var(--shadow-1);
      flex-shrink: 0;
    }

    body.dark-mode .brand-logo {
      opacity: 0.95;
      filter: brightness(0.95);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-name {
      font-weight: var(--font-weight-black);
      letter-spacing: -0.01em;
      color: var(--text-primary);
      font-size: 13px;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .brand-kicker {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      color: var(--text-muted);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
    }

    .seal {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      flex-shrink: 0;
    }

    @media (max-width: 640px) {
      .brand-logo { 
        width: 55px;
        height: 55px;
        padding: 6px; 
      }
      .brand-name { 
        font-size: 12px; 
      }
      .brand-kicker {
        font-size: 11px;
      }
    }

    h1 {
      margin: 0 0 var(--space-xs) 0;
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-black);
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .subtitle {
      margin: 0;
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      max-width: 72ch;
      line-height: 1.55; /* MEJORADO */
    }

    @media (max-width: 640px) {
      h1 { 
        font-size: var(--font-size-lg); 
      }
      .subtitle {
        font-size: 13px;
      }
    }

    /* Provider panel */
    .provider {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
      padding: var(--space-md);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: var(--shadow-1);
      max-width: 100%;
      text-decoration: none;
      color: inherit;
      transition: all 0.2s ease;
    }

    .provider:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-2);
      transform: translateY(-1px);
    }

    .provider:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    @media (min-width: 768px) {
      .provider { max-width: 520px; }
    }

    .provider img {
      width: 83px;
      height: 83px;
      object-fit: contain;
      border-radius: 0;
      border: 1px solid var(--border);
      background: #fff;
      padding: 8px;
      flex-shrink: 0;
    }

    .provider strong {
      display: block;
      color: var(--text-primary);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      margin-bottom: 3px;
      letter-spacing: -0.01em;
    }

    .provider span {
      display: block;
      color: var(--text-tertiary);
      font-size: 12px;
      line-height: 1.4;
      font-weight: var(--font-weight-medium);
    }

    @media (max-width: 640px) {
      .provider { 
        max-width: 100%; 
        padding: var(--space-sm);
      }
      .provider img { 
        width: 74px;
        height: 74px;
      }
      .provider strong {
        font-size: 14px;
      }
      .provider span {
        font-size: 11px;
      }
    }

    /* Barra de actualización */
    .updateBar {
      display: flex;
      gap: var(--space-xs);
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: var(--space-sm);
    }

    @media (min-width: 768px) {
      .updateBar { margin-top: 0; }
    }

    @media (max-width: 640px) {
      .updateBar {
        justify-content: flex-start;
        width: 100%;
      }
    }

    .pill {
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-muted);
      font-size: var(--font-size-xs);
      border-radius: 999px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      white-space: nowrap;
      font-weight: var(--font-weight-semibold);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      border-radius: 0;
      padding: 8px 12px;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      transition: all var(--transition-subtle);
      min-height: 36px;
    }

    .btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border-medium);
    }

    .btn:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    .btn.primary {
      background: var(--primary);
      color: var(--text-on-primary);
      border-color: var(--primary);
    }

    .btn.primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
    }

    .btn.danger {
      background: transparent;
      color: var(--danger);
      border-color: var(--danger-border);
    }

    .btn.danger:hover {
      background: var(--danger-bg);
      border-color: var(--danger);
    }

    .hidden { display: none !important; }

    /* ═══════════════════════════════════════════════════════════════
       SECTION HEADERS - BLOQUES CLAROS
       ═══════════════════════════════════════════════════════════════ */
    .sectionHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    @media (max-width: 640px) {
      .sectionHead {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
    }

    .sectionHead h2 {
      margin: 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-primary);
      font-weight: var(--font-weight-black);
    }

    .sectionHead .hint {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: var(--font-weight-medium);
    }

    /* ═══════════════════════════════════════════════════════════════
       CONTROLES - MÁS LEGIBLES
       ═══════════════════════════════════════════════════════════════ */
    .module__divider { border-top: 1px solid var(--border); }

    .controls {
      padding: var(--space-md);
      display: grid;
      gap: 10px; /* MEJORADO */
      background: var(--bg-primary);
    }

    @media (min-width: 640px) {
      .controls {
        grid-template-columns: 1.2fr 0.7fr 0.7fr 0.7fr 0.6fr;
      }
    }

    @media (max-width: 640px) {
      .controls { 
        grid-template-columns: 1fr; 
        padding: var(--space-sm);
      }
    }

    .field {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 10px; /* MEJORADO */
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .field label {
      font-size: 12px; /* MEJORADO */
      color: var(--text-secondary);
      white-space: nowrap;
      font-weight: var(--font-weight-bold);
    }

    input[type="search"],
    select {
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px; /* MEJORADO */
      font-family: inherit;
    }

    /* ═══════════════════════════════════════════════════════════════
       CHIPS - CON TÍTULO Y LIMPIAR
       ═══════════════════════════════════════════════════════════════ */
    .chipsWrap {
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
    }

    .chipsHeader {
      padding: 12px 14px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .chipsTitle {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-primary);
      font-weight: var(--font-weight-black);
    }

    .chips {
      padding: 0 var(--space-md) var(--space-md);
      display: flex;
      gap: 8px; /* MEJORADO */
      flex-wrap: wrap;
    }

    @media (max-width: 640px) {
      .chips {
        padding: 0 var(--space-sm) var(--space-sm);
      }
      .chipsHeader {
        padding: 10px 10px 6px;
      }
    }

    .chip {
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.2);
      background: rgba(37, 99, 235, 0.08);
      color: #1e3a8a;
      font-size: var(--font-size-xs);
      cursor: pointer;
      user-select: none;
      transition: all var(--transition-subtle);
      font-weight: var(--font-weight-semibold);
    }

    .chip:hover {
      background: rgba(37, 99, 235, 0.12);
    }

    .chip.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    body.dark-mode .chip {
      color: #93c5fd;
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    body.dark-mode .chip.active {
      background: var(--primary-light);
      color: #0F172A;
    }

    /* ═══════════════════════════════════════════════════════════════
       BARRA DE RESULTADOS
       ═══════════════════════════════════════════════════════════════ */
    .resultsBar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      margin: 0 var(--space-md);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 0;
    }

    .resultsBar strong {
      color: var(--text-primary);
      font-weight: var(--font-weight-bold);
    }

    @media (max-width: 640px) {
      .resultsBar {
        flex-direction: column;
        align-items: flex-start;
        margin: 0 var(--space-sm);
        gap: 6px;
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       LEGAL BOX
       ═══════════════════════════════════════════════════════════════ */
    .legal {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-left: 3px solid var(--primary);
      border-radius: 0;
      box-shadow: var(--shadow-1);
      padding: var(--space-md);
      margin: 0 var(--space-md) var(--space-lg) var(--space-md);
    }

    @media (max-width: 640px) {
      .legal { margin: 0 var(--space-sm) var(--space-md) var(--space-sm); }
    }

    .legal h2 {
      margin: 0 0 var(--space-xs) 0;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      font-weight: var(--font-weight-bold);
    }

    .legal p {
      margin: 0;
      color: var(--text-secondary);
      font-size: var(--font-size-xs);
      line-height: 1.5;
    }

    .legal p + p {
      margin-top: var(--space-sm);
    }

    .legal .small {
      color: var(--text-tertiary);
      font-size: 11px;
      margin-top: var(--space-xs);
    }

    /* ═══════════════════════════════════════════════════════════════
       METAROW
       ═══════════════════════════════════════════════════════════════ */
    .metaRow {
      margin: var(--space-md) var(--space-md) 0;
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
      color: var(--text-tertiary);
      font-size: var(--font-size-xs);
    }

    @media (max-width: 640px) {
      .metaRow { 
        margin: var(--space-sm); 
        justify-content: center;
        text-align: center;
      }
    }

    .small {
      color: var(--text-muted);
      font-size: 11px;
    }

    /* ═══════════════════════════════════════════════════════════════
       ICONOS SVG
       ═══════════════════════════════════════════════════════════════ */
    .icon-inline {
      display: inline-block;
      width: 14px;
      height: 14px;
      vertical-align: -2px;
      margin-right: 4px;
    }

    .icon-inline svg {
      width: 100%;
      height: 100%;
      fill: currentColor;
      stroke: currentColor;
    }

    /* ═══════════════════════════════════════════════════════════════
       GRID
       ═══════════════════════════════════════════════════════════════ */
    .grid {
      display: grid;
      gap: var(--space-md);
      padding: var(--space-md);
    }

    @media (min-width: 640px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1024px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (min-width: 1400px) {
      .grid { grid-template-columns: repeat(4, 1fr); }
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
        padding: var(--space-sm);
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       CARDS - MEJORADAS
       ═══════════════════════════════════════════════════════════════ */
    .card {
      position: relative;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: var(--shadow-1);
      padding: 14px 14px 12px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px; /* MEJORADO */
      transition: box-shadow 0.15s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 6px; /* MEJORADO */
      background: var(--border-strong);
    }

    .card[data-status="open"]::before { background: var(--ok); }
    .card[data-status="wait"]::before { background: var(--warn); }
    .card[data-status="closed"]::before { background: var(--neutral); }

    .card:hover {
      box-shadow: var(--shadow-2);
    }

    .grid .card:nth-child(odd) {
      background: linear-gradient(0deg, rgba(15,23,42,0.02), rgba(15,23,42,0.02)), var(--bg-primary);
    }

    body.dark-mode .grid .card:nth-child(odd) {
      background: linear-gradient(0deg, rgba(241,245,249,0.03), rgba(241,245,249,0.03)), var(--bg-primary);
    }

    .courseHeader {
      display: grid;
      gap: 6px;
    }

    .courseTitle {
      font-size: 15px;
      font-weight: 800;
      letter-spacing: -0.01em;
      line-height: 1.3;
      color: var(--text-primary);
      margin: 0;
    }

    @media (max-width: 640px) {
      .courseTitle {
        font-size: 14px;
      }
    }

    .courseMetaLine {
      display: flex;
      flex-wrap: wrap;
      gap: 8px; /* MEJORADO */
      align-items: center;
      font-size: 12px;
    }

    @media (max-width: 640px) {
      .courseMetaLine {
        gap: 6px;
      }
    }

    .pillMeta {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      padding: 5px 9px; /* MEJORADO */
      border-radius: 999px;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 11px;
      white-space: nowrap;
    }

    @media (max-width: 640px) {
      .pillMeta {
        font-size: 10px;
        padding: 4px 7px;
      }
    }

    /* Categoría destacada */
    .pillCategory {
      background: rgba(37, 99, 235, 0.08);
      border-color: rgba(37, 99, 235, 0.2);
      color: var(--primary);
      font-weight: 700;
    }

    body.dark-mode .pillCategory {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    .cardDivider {
      height: 1px;
      background: var(--border);
      opacity: 0.7;
      margin: 0;
    }

    .card .desc {
      font-size: 13px; /* MEJORADO */
      color: var(--text-secondary);
      line-height: 1.6; /* MEJORADO */
      margin: 0;
    }

    @media (max-width: 640px) {
      .card .desc {
        font-size: 12px;
      }
    }

    .card .actions {
      gap: 8px;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 640px) {
      .card .actions {
        flex-direction: row;
      }
    }

    .card a.linkBtn {
      min-height: 36px;
      padding: 8px 12px;
      font-size: 13px;
      text-align: center;
      flex: 1;
    }

    @media (max-width: 640px) {
      .card a.linkBtn {
        width: 100%;
      }
    }

    a.linkBtn.whatsapp-btn {
      background: transparent;
      color: #128C7E;
      border-color: rgba(18, 140, 126, 0.35);
    }

    a.linkBtn.whatsapp-btn:hover {
      background: rgba(18, 140, 126, 0.08);
      border-color: rgba(18, 140, 126, 0.6);
    }

    body.dark-mode a.linkBtn.whatsapp-btn {
      color: #25D366;
      border-color: rgba(37, 211, 102, 0.4);
    }

    body.dark-mode a.linkBtn.whatsapp-btn:hover {
      background: rgba(37, 211, 102, 0.1);
      border-color: rgba(37, 211, 102, 0.6);
    }

    .pillSoon {
      border-color: rgba(217, 119, 6, 0.35);
      background: rgba(217, 119, 6, 0.10);
      color: var(--warn);
      font-weight: 700;
    }

    .courseHeader .small {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: -2px;
    }

    @media (max-width: 640px) {
      .courseHeader .small {
        font-size: 10px;
      }
    }

    .card .badge {
      font-size: 9px; /* MEJORADO - más pequeño */
      padding: 5px 9px;
      font-weight: 700;
      align-self: flex-start;
    }

    .topRow {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-sm);
    }

    .badge {
      min-width: 90px;
      text-align: center;
      font-size: 9px;
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid transparent;
      white-space: nowrap;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    @media (max-width: 640px) {
      .badge {
        min-width: 80px;
        font-size: 8px;
        padding: 4px 7px;
      }
    }

    .badge.open {
      background: var(--ok-bg);
      color: var(--ok);
      border-color: var(--ok-border);
    }

    .badge.wait {
      background: var(--warn-bg);
      color: var(--warn);
      border-color: var(--warn-border);
    }

    .badge.closed {
      background: var(--neutral-bg);
      color: var(--neutral);
      border-color: var(--neutral-border);
    }

    .empty {
      background: var(--bg-secondary);
      border: 2px dashed var(--border-medium);
      border-radius: 0;
      padding: var(--space-xl);
      text-align: center;
      color: var(--text-tertiary);
      grid-column: 1 / -1;
    }

    .empty strong {
      display: block;
      color: var(--text-primary);
      font-size: var(--font-size-base);
      margin-bottom: var(--space-xs);
    }

    @media (max-width: 640px) {
      .empty {
        padding: var(--space-lg);
      }
      .empty strong {
        font-size: 14px;
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       VISTA TABLA
       ═══════════════════════════════════════════════════════════════ */
    #tableView {
      padding: var(--space-md);
    }

    @media (max-width: 640px) {
      #tableView {
        padding: var(--space-sm);
      }
    }

    #tableView > div {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 0;
      overflow: hidden;
      box-shadow: var(--shadow-1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-xs);
    }

    @media (max-width: 640px) {
      table { 
        font-size: 11px; 
      }
    }

    thead tr {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      padding: 8px 10px;
      color: var(--text-muted);
      font-weight: var(--font-weight-bold);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    @media (max-width: 640px) {
      th {
        padding: 6px 8px;
        font-size: 10px;
      }
    }

    tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      color: var(--text-secondary);
    }

    @media (max-width: 640px) {
      tbody td {
        padding: 6px 8px;
      }
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--bg-secondary);
    }

    /* ═══════════════════════════════════════════════════════════════
       IMPORTACIÓN
       ═══════════════════════════════════════════════════════════════ */
    .importBox {
      margin: var(--space-md);
      border: 2px dashed var(--border-medium);
      border-radius: 0;
      padding: var(--space-md);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: var(--font-size-xs);
    }

    @media (max-width: 640px) {
      .importBox {
        margin: var(--space-sm);
        padding: var(--space-sm);
      }
    }

    .importBox strong {
      color: var(--text-primary);
    }

    .drop {
      margin-top: var(--space-sm);
      border: 1px dashed var(--border-medium);
      border-radius: 0;
      padding: var(--space-sm);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-sm);
      flex-wrap: wrap;
      cursor: pointer;
      transition: all var(--transition-subtle);
    }

    .drop:hover {
      background: var(--bg-primary);
      border-color: var(--primary);
    }

    .drop strong {
      color: var(--text-primary);
    }

    /* ═══════════════════════════════════════════════════════════════
       TOAST
       ═══════════════════════════════════════════════════════════════ */
    .toast {
      position: fixed;
      bottom: var(--space-xl);
      right: var(--space-xl);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: var(--shadow-3);
      padding: var(--space-md) var(--space-lg);
      max-width: 400px;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--font-size-sm);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left: 3px solid var(--ok); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--info); }

    .toast strong { 
      color: var(--text-primary); 
      font-weight: var(--font-weight-bold);
    }

    @media (max-width: 640px) {
      .toast {
        bottom: var(--space-md);
        right: var(--space-md);
        left: var(--space-md);
        max-width: none;
        font-size: 13px;
        padding: var(--space-sm) var(--space-md);
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       LOADING
       ═══════════════════════════════════════════════════════════════ */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-overlay);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(2px);
      pointer-events: none;
    }

    .loading-overlay.active { 
      display: flex; 
      pointer-events: all;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ═══════════════════════════════════════════════════════════════
       ADMIN MODE
       ═══════════════════════════════════════════════════════════════ */
    body:not(.admin-mode) .admin-only {
      display: none !important;
    }

    /* ═══════════════════════════════════════════════════════════════
       NOTICE - MEJORADO Y CLARO
       ═══════════════════════════════════════════════════════════════ */
    .notice {
      margin: 0 var(--space-md) var(--space-md);
      border: 1px solid var(--border);
      background: var(--bg-primary);
      box-shadow: var(--shadow-1);
      border-radius: 0;
    }

    @media (max-width: 640px) {
      .notice {
        margin: 0 var(--space-sm) var(--space-sm);
      }
    }

    .notice__bar {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--info-bg);
      border-left: 3px solid var(--info);
      transition: background 0.15s ease;
    }

    .notice__bar:hover {
      background: rgba(2, 132, 199, 0.12);
    }

    @media (max-width: 640px) {
      .notice__bar {
        flex-wrap: wrap;
        gap: var(--space-sm);
        padding: var(--space-sm);
      }
    }

    .notice__icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--info);
      color: #fff;
      border-radius: 50%;
      font-size: 14px;
      font-weight: var(--font-weight-bold);
      flex-shrink: 0;
    }

    .notice__content-simple {
      flex: 1;
      min-width: 0;
    }

    .notice__content-simple h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      color: var(--text-primary);
      font-weight: var(--font-weight-bold);
    }

    .notice__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .notice__list li {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.5;
    }

    .notice__list li::before {
      content: "✓";
      color: var(--ok);
      font-weight: bold;
      flex-shrink: 0;
    }

    .notice__btn {
      min-height: 32px;
      padding: 6px 12px;
      font-size: var(--font-size-xs);
      background: transparent;
      border: 1px solid var(--info);
      color: var(--info);
      flex-shrink: 0;
    }

    .notice__btn:hover {
      background: var(--info);
      color: #fff;
    }

    .notice__btn::after {
      content: ' ▼';
      font-size: 10px;
      margin-left: 4px;
      transition: transform 0.2s ease;
      display: inline-block;
    }

    .notice__btn[aria-expanded="true"]::after {
      transform: rotate(180deg);
    }

    @media (max-width: 640px) {
      .notice__btn {
        order: 3;
        width: 100%;
      }
      .notice__content-simple {
        order: 2;
        flex-basis: 100%;
      }
    }

    .notice__details {
      padding: var(--space-md);
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    @media (max-width: 640px) {
      .notice__details {
        padding: var(--space-sm);
      }
    }

    .notice__details-content {
      display: grid;
      gap: var(--space-md);
      align-items: start;
    }

    @media (min-width: 768px) {
      .notice__details-content {
        grid-template-columns: 1fr 200px;
      }
    }

    .notice__text-block p {
      margin: 0 0 var(--space-sm);
      font-size: var(--font-size-sm);
      line-height: 1.65; /* MEJORADO */
      color: var(--text-secondary);
    }

    @media (max-width: 640px) {
      .notice__text-block p {
        font-size: 12px;
      }
    }

    .notice__text-block p:last-child {
      margin-bottom: 0;
    }

    .notice__text-block strong {
      color: var(--text-primary);
      font-weight: var(--font-weight-bold);
    }

    .notice__image {
      width: 100%;
      max-width: 200px;
      height: auto;
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: var(--shadow-1);
      display: block;
    }

    @media (max-width: 767px) {
      .notice__image {
        max-width: 100%;
        margin: 0 auto;
      }
    }

    /* ═══════════════════════════════════════════════════════════════
       ACCESIBILIDAD
       ═══════════════════════════════════════════════════════════════ */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .skip-link {
      position: absolute;
      left: -9999px;
      top: 8px;
      background: var(--primary);
      color: #fff;
      border: 2px solid var(--primary-dark);
      padding: 10px 16px;
      z-index: 10001;
      font-weight: var(--font-weight-bold);
      text-decoration: none;
      border-radius: 0;
      box-shadow: var(--shadow-3);
      font-size: var(--font-size-sm);
    }

    .skip-link:focus {
      left: 8px;
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }

    body.dark-mode .skip-link {
      background: var(--primary-light);
      color: #0F172A;
      border-color: var(--primary-light);
    }

    /* ═══════════════════════════════════════════════════════════════
       ANIMACIONES
       ═══════════════════════════════════════════════════════════════ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      animation: fadeIn 0.3s ease-out backwards;
    }

    .card:nth-child(1) { animation-delay: 0.05s; }
    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.15s; }
    .card:nth-child(4) { animation-delay: 0.2s; }
  </style>
</head>

<body>
  <a class="skip-link" href="#grid">Saltar al listado de cursos</a>

  <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema" title="Cambiar entre modo claro y oscuro">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </button>

  <div class="fondos-section">
    <div class="fondos-container">
      <div class="fondos-text">
        <h2 class="fondos-title">Financiado con fondos europeos</h2>
        <p class="fondos-desc">
          Formación gratuita cofinanciada por el Fondo Social Europeo Plus (FSE+) en el marco del Programa Nacional de Formación para el Empleo.
        </p>
      </div>
      <div class="fondos-logos" aria-label="Logos institucionales">
        <img src="https://herrerahoy.es/img/comunidad/cursos/ministerio.png" 
             alt="Ministerio de Trabajo y Economía Social - Gobierno de España - Fondo Social Europeo Plus" 
             class="fondo-logo-ministerio" />
      </div>
    </div>
  </div>

  <div class="wrap">
    <section class="module" aria-label="Cursos subvencionados">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
      </div>
      
      <div class="module__top">
        <div class="titleBlock">
          <div class="brandline">
            <div class="brand">
              <img src="https://herrerahoy.es/img/mapaherrera.png" alt="Herrera Hoy" class="brand-logo" />
              <div class="brand-text">
                <div class="brand-name">Herrera Hoy</div>
                <div class="brand-kicker">
                  <span class="seal" aria-hidden="true"></span>
                  <span id="updatedText">Actualizado: —</span>
                </div>
              </div>
            </div>
          </div>
          <h1>Cursos subvencionados</h1>
          <p class="subtitle">
            Formación profesional gratuita para trabajadores y desempleados. Actualización semanal.
          </p>
        </div>

        <a href="https://grupodaboconsulting.com/" 
           target="_blank" 
           rel="noopener noreferrer"
           class="provider" 
           aria-label="Visitar web de Grupo Dabo - Entidad formadora">
          <img src="https://herrerahoy.es/img/comunidad/cursos/grupodabo.png" alt="Logo Grupo Dabo" />
          <div>
            <strong>Grupo Dabo</strong>
            <span>Entidad que imparte y gestiona la formación (plazas y admisión).</span>
          </div>
        </a>

        <div class="updateBar">
          <span class="pill" title="Total de cursos visibles">
            <strong id="count">0</strong>&nbsp; cursos
          </span>
          <button class="btn" id="toggleView" type="button" aria-pressed="false">Ver tabla</button>
          <button class="btn danger" id="clearFilters" type="button" style="display:none;">Limpiar filtros</button>
          <label class="btn primary admin-only" for="csvFile">Importar</label>
          <input id="csvFile" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="hidden admin-only" aria-label="Seleccionar archivo" />
        </div>
        
        <div class="small" style="text-align:right; max-width: 360px; margin-top: var(--space-xs); color: var(--text-tertiary);">
          Inscripción y requisitos: enlace oficial del curso (Grupo Dabo).
        </div>
      </div>

      <div class="module__divider"></div>

      <!-- BLOQUE: FILTROS -->
      <div class="sectionHead">
        <h2>Filtrar cursos</h2>
        <div class="hint">Busca por palabra, elige modalidad o categoría</div>
      </div>

      <div class="controls" aria-label="Filtros">
        <div class="field">
          <label for="q">Buscar</label>
          <input id="q" type="search" placeholder="Marketing, Prestashop…" autocomplete="off" />
        </div>

        <div class="field">
          <label for="cat">Categoría</label>
          <select id="cat">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="field">
          <label for="mod">Modalidad</label>
          <select id="mod">
            <option value="">Todas</option>
            <option>Online</option>
            <option>Presencial</option>
            <option>Mixta</option>
          </select>
        </div>

        <div class="field">
          <label for="sort">Orden</label>
          <select id="sort">
            <option value="dateAsc">Próximos primero</option>
            <option value="dateDesc">Lejanos primero</option>
            <option value="titleAsc">A–Z</option>
          </select>
        </div>

        <div class="field">
          <label for="upcoming">Mostrar</label>
          <select id="upcoming">
            <option value="1">Solo próximos</option>
            <option value="0">Todos</option>
          </select>
        </div>
      </div>

      <!-- BLOQUE: ATAJOS -->
      <div class="chipsWrap">
        <div class="chipsHeader">
          <div class="chipsTitle">Atajos rápidos</div>
          <button class="btn danger" id="clearChip" type="button" style="display:none; font-size:11px; padding:4px 8px; min-height:28px;">Limpiar</button>
        </div>
        <div class="chips" id="chips" aria-label="Atajos"></div>
      </div>
    </section>

    <!-- AVISO MEJORADO -->
    <section class="notice" aria-label="Aviso importante">
      <div class="notice__bar">
        <div class="notice__icon">i</div>
        
        <div class="notice__content-simple">
          <h3>Aviso importante</h3>
          <ul class="notice__list">
            <li>Inscripción solo en el enlace oficial de Grupo Dabo</li>
            <li>Fechas y plazas pueden cambiar según convocatoria</li>
          </ul>
        </div>

        <button class="btn notice__btn" type="button" id="toggleNotice" aria-expanded="false" aria-controls="noticeDetails">
          Más info
        </button>
      </div>

      <div class="notice__details hidden" id="noticeDetails">
        <div class="notice__details-content">
          <div class="notice__text-block">
            <p>
              <strong>Herrera Hoy</strong> actúa como <strong>medio informativo</strong>.
              No realiza intermediación, gestión de inscripciones ni selección de alumnado.
              Toda tramitación corresponde a <strong>Grupo Dabo</strong>.
            </p>
            <p>
              La admisión está sujeta a los requisitos del programa, disponibilidad de plazas y criterios de priorización aplicables en cada convocatoria.
              Con carácter general, pueden priorizarse personas empleadas en el sector relacionado con la formación (si cumplen requisitos).
              En caso de existir vacantes, la formación puede abrirse también a personas desempleadas hasta completar plazas.
              <strong>Los criterios pueden variar según convocatoria</strong> y la entidad organizadora podrá actualizar fechas, plazas o requisitos.
            </p>
            <p class="small">
              <strong>Confirma siempre requisitos y plazas en el enlace oficial del curso.</strong>
            </p>
          </div>
          <img src="https://herrerahoy.es/img/comunidad/cursos/ministerio.png" 
               alt="Ministerio de Trabajo y Economía Social - Gobierno de España" 
               class="notice__image" />
        </div>
      </div>
    </section>

    <!-- BARRA DE RESULTADOS -->
    <div class="resultsBar" aria-label="Resultados">
      <div><strong id="resultsCountText">Mostrando — cursos</strong></div>
      <div class="small" id="activeFiltersText">Filtros: —</div>
    </div>

    <section id="cardsView" aria-label="Listado en tarjetas">
      <div id="grid" class="grid" tabindex="-1"></div>
    </section>

    <section id="tableView" class="hidden" aria-label="Listado en tabla">
      <div>
        <table aria-label="Listado de cursos subvencionados">
          <thead>
            <tr>
              <th scope="col">Curso</th>
              <th scope="col">Categoría</th>
              <th scope="col">Inicio</th>
              <th scope="col">Modalidad</th>
              <th scope="col">Estado</th>
              <th scope="col">Acción</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <div class="importBox admin-only">
      <strong>Actualizar datos:</strong> 
      Importa CSV/TSV actualizado.
      
      <div class="drop" id="dropZone" role="button" tabindex="0">
        <div>
          <strong>Arrastra archivo aquí</strong>
          <div class="small">CSV o TSV con campos: id, titulo, categoria, inicio, modalidad, estado, url</div>
        </div>
        <button class="btn" id="downloadTemplate" type="button">Plantilla</button>
      </div>
    </div>

  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // SVG ICONS
    // ═══════════════════════════════════════════════════════════════
    const SVG_ICONS = {
      calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
      
      bolt: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
      
      tag: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>',
      
      monitor: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>',
      
      clock: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
      
      whatsapp: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>',
      
      check: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
      
      hourglass: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2v6h.01M6 18v6h.01m12.01-6v6h.01m-.01-18v6h.01M6 8a6 6 0 0 0 12 0m-12 8a6 6 0 0 0 12 0"></path></svg>',
      
      xmark: '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
    };

    function getSVG(name) {
      return SVG_ICONS[name] || '';
    }

    function createIconSpan(iconName) {
      const span = document.createElement('span');
      span.className = 'icon-inline';
      span.innerHTML = getSVG(iconName);
      span.setAttribute('aria-hidden', 'true');
      return span;
    }

    // ═══════════════════════════════════════════════════════════════
    // ADMIN MODE
    // ═══════════════════════════════════════════════════════════════
    const ADMIN_MODE = new URLSearchParams(window.location.search).has('admin');
    if (ADMIN_MODE) {
      document.body.classList.add('admin-mode');
      console.log('🔧 Modo administración activado');
    }

    // ═══════════════════════════════════════════════════════════════
    // TOAST
    // ═══════════════════════════════════════════════════════════════
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const strong = document.createElement("strong");
      strong.textContent = String(message);
      toast.appendChild(strong);
      
      toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
      toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      toast.setAttribute('aria-atomic', 'true');
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ═══════════════════════════════════════════════════════════════
    // DARK MODE
    // ═══════════════════════════════════════════════════════════════
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme) {
      if (savedTheme === 'dark') {
        body.classList.add('dark-mode');
      }
    } else {
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        body.classList.add('dark-mode');
      }
    }

    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // ═══════════════════════════════════════════════════════════════
    // DATOS DEMO
    // ═══════════════════════════════════════════════════════════════
    let UPDATED_AT = "2026-02-10 10:30";
    let COURSES = [
      { id: "F241674AA", title: "Transformación digital", category: "Comercio Y Marketing", modality: "Online", startDate: "2026-03-16", status: "open", url: "#", info: "Herramientas digitales para negocio.", hours: 60, _haystack: "transformacion digital comercio y marketing online f241674aa herramientas digitales para negocio" },
      { id: "F241677AA", title: "Prestashop avanzado", category: "Comercio Y Marketing", modality: "Online", startDate: "2026-03-16", status: "open", url: "#", info: "Tienda online profesional.", hours: 40, _haystack: "prestashop avanzado comercio y marketing online f241677aa tienda online profesional" },
      { id: "F241694AA", title: "Técnicas de venta", category: "Comercio Y Marketing", modality: "Presencial", startDate: "2026-03-16", status: "wait", url: "#", info: "Cierre y fidelización.", hours: 50, _haystack: "tecnicas de venta comercio y marketing presencial f241694aa cierre y fidelizacion" },
      { id: "F241686AA", title: "Talento digital", category: "Servicios", modality: "Online", startDate: "2026-03-02", status: "open", url: "#", info: "Competencias digitales.", hours: 45, _haystack: "talento digital servicios online f241686aa competencias digitales" },
      { id: "BIOCIDAS", title: "Biocidas profesional", category: "Servicios", modality: "Mixta", startDate: "2026-02-23", status: "closed", url: "#", info: "Protocolos de seguridad.", hours: 80, _haystack: "biocidas profesional servicios mixta biocidas protocolos de seguridad" }
    ];

    const state = { q: "", cat: "", mod: "", upcoming: true, sort: "dateAsc", chip: "", view: "cards" };

    const $ = (s) => document.querySelector(s);
    const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

    // ═══════════════════════════════════════════════════════════════
    // UTILIDADES
    // ═══════════════════════════════════════════════════════════════
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function getWhatsAppLink(courseTitle) {
      const phoneNumber = "34663886719";
      const message = `Hola, quiero información sobre el curso de ${courseTitle}`;
      const encodedMessage = encodeURIComponent(message);
      return `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    }
    
    function formatDate(iso) {
      if (!iso) return "—";
      const [y, m, d] = iso.split("-").map(Number);
      return `${String(d).padStart(2, "0")}/${String(m).padStart(2, "0")}/${y}`;
    }

    function isUpcoming(iso) {
      if (!iso) return true;
      const today = new Date(); 
      today.setHours(0, 0, 0, 0);
      const dt = new Date(iso + "T00:00:00");
      return dt >= today;
    }

    function statusLabel(s) {
      if (s === "open") return "ABIERTO";
      if (s === "wait") return "ESPERA";
      return "CERRADO";
    }

    function daysUntil(iso) {
      if (!iso) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const dt = new Date(iso + "T00:00:00");
      return Math.round((dt - today) / 86400000);
    }

    function normalize(s) {
      return String(s || "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function titleCaseEs(input) {
      const small = new Set(["y","e","o","u","de","del","la","las","el","los","en","para","por","con","sin","a"]);
      const words = String(input || "").trim().toLowerCase().split(/\s+/).filter(Boolean);
      return words.map((w, i) => {
        if (i !== 0 && small.has(w)) return w;
        return w.charAt(0).toUpperCase() + w.slice(1);
      }).join(" ");
    }

    function setControlsDisabled(disabled) {
      ["#q", "#cat", "#mod", "#sort", "#upcoming", "#toggleView", "#clearFilters", "#clearChip"].forEach(sel => {
        const node = $(sel);
        if (!node) return;
        node.disabled = !!disabled;
        node.setAttribute("aria-disabled", disabled ? "true" : "false");
      });
    }

    function focusFirstInView() {
      if (state.view === "table") {
        const firstLink = document.querySelector("#tbody a");
        const target = firstLink || document.querySelector("#tableView table") || document.querySelector("#toggleView");
        if (target) target.focus();
        announce("Vista tabla activada");
      } else {
        const firstAction = document.querySelector("#grid a.linkBtn.primary, #grid a.linkBtn, #grid .card, #grid .empty");
        const target = firstAction || document.querySelector("#toggleView");
        if (target) target.focus();
        announce("Vista tarjetas activada");
      }
    }

    function normalizeModality(raw) {
      const m = normalize(raw);
      if (m.includes("online") || m.includes("on line")) return "Online";
      if (m.includes("presencial")) return "Presencial";
      if (m.includes("mixta") || m.includes("hibrida") || m.includes("blended")) return "Mixta";
      return raw.trim() || "—";
    }

    const QUICK_CHIPS = ["Online", "Presencial", "Comercio y Marketing", "Servicios"];

    function refreshCategorySelect() {
      const sel = $("#cat");
      const current = sel.value;
      sel.innerHTML = `<option value="">Todas</option>`;
      
      const cats = Array.from(new Set(COURSES.map(c => (c.category || "").trim()).filter(Boolean)))
        .sort((a, b) => a.localeCompare(b, "es"));
      
      for (const c of cats) {
        sel.appendChild(el("option", { value: c, textContent: c }));
      }
      
      if (cats.includes(current)) sel.value = current;
    }

    function applyFilters(items) {
      let out = items.slice();

      if (state.chip) {
        const t = normalize(state.chip);
        out = out.filter(c => normalize(`${c.category} ${c.modality}`).includes(t));
      }
      if (state.cat) out = out.filter(c => (c.category || "") === state.cat);
      if (state.mod) out = out.filter(c => (c.modality || "") === state.mod);
      
      if (state.upcoming) {
        out = out.filter(c => isUpcoming(c.startDate) && c.status !== "closed");
      }
      
      if (state.q) {
        const qNorm = state.q;
        out = out.filter(c => {
          if (c._haystack) {
            return c._haystack.includes(qNorm);
          } else {
            return normalize(`${c.title} ${c.category} ${c.modality} ${c.id} ${c.info}`).includes(qNorm);
          }
        });
      }

      out.sort((a, b) => {
        if (state.sort === "titleAsc") return (a.title || "").localeCompare((b.title || ""), "es");
        if (state.sort === "dateDesc") return new Date(b.startDate || "2100-01-01") - new Date(a.startDate || "2100-01-01");
        return new Date(a.startDate || "2100-01-01") - new Date(b.startDate || "2100-01-01");
      });

      return out;
    }

    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live', 'polite');
    announcer.className = 'sr-only';
    document.body.appendChild(announcer);

    function announce(msg) {
      try { announcer.textContent = msg; } catch(e) {}
    }

    function render() {
      $("#updatedText").textContent = `Actualizado: ${UPDATED_AT}`;
      refreshCategorySelect();

      const chipsWrap = $("#chips");
      chipsWrap.innerHTML = "";
      QUICK_CHIPS.forEach(label => {
        const c = el("div", { className: "chip", textContent: label });
        c.classList.toggle("active", state.chip === label);
        c.addEventListener("click", () => {
          state.chip = (state.chip === label) ? "" : label;
          render();
        });
        chipsWrap.appendChild(c);
      });

      // Botón limpiar chip
      const clearChipBtn = $("#clearChip");
      if (clearChipBtn) {
        clearChipBtn.style.display = state.chip ? "inline-flex" : "none";
      }

      const items = applyFilters(COURSES);
      $("#count").textContent = items.length;

      // BARRA DE RESULTADOS
      const rc = document.getElementById("resultsCountText");
      if (rc) rc.textContent = `Mostrando ${items.length} curso${items.length !== 1 ? "s" : ""}`;

      const af = document.getElementById("activeFiltersText");
      if (af) {
        const parts = [];
        if (state.q) parts.push("búsqueda");
        if (state.cat) parts.push(`categoría: ${state.cat}`);
        if (state.mod) parts.push(`modalidad: ${state.mod}`);
        if (state.chip) parts.push(`atajo: ${state.chip}`);
        if (state.upcoming) parts.push("solo próximos");
        af.textContent = parts.length ? `Filtros: ${parts.join(" · ")}` : "Filtros: ninguno";
      }

      // Botón limpiar filtros
      const clearBtn = $("#clearFilters");
      if (clearBtn) {
        const hasFilters = state.q || state.cat || state.mod || state.chip || !state.upcoming;
        clearBtn.style.display = hasFilters ? "inline-flex" : "none";
      }

      $("#cardsView").classList.toggle("hidden", state.view !== "cards");
      $("#tableView").classList.toggle("hidden", state.view !== "table");
      const toggleBtn = $("#toggleView");
      toggleBtn.textContent = (state.view === "cards") ? "Ver tabla" : "Ver tarjetas";
      toggleBtn.setAttribute("aria-pressed", state.view === "table");

      const grid = $("#grid");
      grid.innerHTML = "";
      
      if (items.length === 0) {
        const emptyDiv = el("div", { className: "empty" });
        emptyDiv.tabIndex = -1;
        const emptyStrong = el("strong", { textContent: "Sin resultados." });
        const emptyBr = document.createElement("br");
        const emptyText = document.createTextNode("Ajusta filtros o busca otra palabra.");
        emptyDiv.appendChild(emptyStrong);
        emptyDiv.appendChild(emptyBr);
        emptyDiv.appendChild(emptyText);
        grid.appendChild(emptyDiv);
      } else {
        const fragment = document.createDocumentFragment();
        
        for (const c of items) {
          const card = el("article", { className: "card" });
          card.dataset.status = c.status || "closed";

          const header = el("div", { className: "courseHeader" });

          const title = el("div", { className: "courseTitle", textContent: c.title || "Sin título" });
          
          const idLine = el("div", { className: "small", textContent: c.id ? `Ref: ${c.id}` : "" });
          
          // Línea 1: Fecha + Modalidad + Horas
          const metaLine = el("div", { className: "courseMetaLine" });
          
          const dateSpan = el("span", { className: "pillMeta" });
          dateSpan.appendChild(createIconSpan('calendar'));
          dateSpan.appendChild(document.createTextNode(formatDate(c.startDate)));
          metaLine.appendChild(dateSpan);
          
          const modSpan = el("span", { className: "pillMeta" });
          modSpan.appendChild(createIconSpan('monitor'));
          modSpan.appendChild(document.createTextNode(c.modality || "—"));
          metaLine.appendChild(modSpan);
          
          if (c.hours) {
            const hourSpan = el("span", { className: "pillMeta" });
            hourSpan.appendChild(createIconSpan('clock'));
            hourSpan.appendChild(document.createTextNode(`${c.hours}h`));
            metaLine.appendChild(hourSpan);
          }

          // Línea 2: Categoría (destacada) + Empieza pronto
          const categoryLine = el("div", { className: "courseMetaLine" });
          
          const catSpan = el("span", { className: "pillMeta pillCategory" });
          catSpan.appendChild(createIconSpan('tag'));
          catSpan.appendChild(document.createTextNode(c.category || "—"));
          categoryLine.appendChild(catSpan);
          
          const d = daysUntil(c.startDate);
          if (d !== null && d >= 0 && d <= 14) {
            const soonSpan = el("span", { className: "pillMeta pillSoon" });
            soonSpan.appendChild(createIconSpan('bolt'));
            soonSpan.appendChild(document.createTextNode(`Empieza en ${d} días`));
            categoryLine.appendChild(soonSpan);
          }

          header.appendChild(title);
          if (c.id) header.appendChild(idLine);
          header.appendChild(metaLine);
          header.appendChild(categoryLine);

          const badgeSpan = el("div", { className: `badge ${c.status || "closed"}` });
          if (c.status === "open") {
            badgeSpan.appendChild(createIconSpan('check'));
            badgeSpan.appendChild(document.createTextNode(statusLabel(c.status)));
          } else if (c.status === "wait") {
            badgeSpan.appendChild(createIconSpan('hourglass'));
            badgeSpan.appendChild(document.createTextNode(statusLabel(c.status)));
          } else {
            badgeSpan.appendChild(createIconSpan('xmark'));
            badgeSpan.appendChild(document.createTextNode(statusLabel(c.status)));
          }

          const top = el("div", { className: "topRow" });
          top.appendChild(header);
          top.appendChild(badgeSpan);

          const desc = el("p", { className: "desc", textContent: c.info || "—" });

          const divider = el("div", { className: "cardDivider" });

          const actions = el("div", { className: "actions" });
          actions.appendChild(el("a", {
            className: "linkBtn primary",
            href: c.url || "#",
            textContent: "Ver ficha oficial",
            target: "_blank",
            rel: "noopener noreferrer"
          }));

          const whatsappBtn = el("a", {
            className: "linkBtn whatsapp-btn",
            href: getWhatsAppLink(c.title),
            target: "_blank",
            rel: "noopener noreferrer",
            title: "Enviar WhatsApp a Grupo Dabo para consultar info y plazas"
          });
          whatsappBtn.innerHTML = getSVG('whatsapp') + ' WhatsApp (info y plazas)';
          actions.appendChild(whatsappBtn);

          card.appendChild(top);
          card.appendChild(desc);
          card.appendChild(divider);
          card.appendChild(actions);

          fragment.appendChild(card);
        }
        
        grid.appendChild(fragment);
      }

      const tbody = $("#tbody");
      tbody.innerHTML = "";
      
      if (items.length) {
        const fragment = document.createDocumentFragment();
        
        for (const c of items) {
          const tr = document.createElement("tr");
          
          const tdCurso = document.createElement("td");
          const strongTitle = document.createElement("strong");
          strongTitle.textContent = c.title || "—";
          const divId = document.createElement("div");
          divId.className = "small";
          divId.textContent = c.id || "—";
          tdCurso.appendChild(strongTitle);
          tdCurso.appendChild(divId);
          
          const tdCategoria = document.createElement("td");
          tdCategoria.textContent = c.category || "—";
          
          const tdInicio = document.createElement("td");
          tdInicio.textContent = formatDate(c.startDate);
          
          const tdModalidad = document.createElement("td");
          tdModalidad.textContent = c.modality || "—";
          
          const tdEstado = document.createElement("td");
          tdEstado.textContent = statusLabel(c.status);
          
          const tdAccion = document.createElement("td");
          const linkVer = document.createElement("a");
          linkVer.className = "linkBtn primary";
          linkVer.href = c.url || "#";
          linkVer.textContent = "Ver ficha";
          linkVer.target = "_blank";
          linkVer.rel = "noopener noreferrer";
          linkVer.title = "Ver ficha oficial del curso";
          tdAccion.appendChild(linkVer);
          
          tr.appendChild(tdCurso);
          tr.appendChild(tdCategoria);
          tr.appendChild(tdInicio);
          tr.appendChild(tdModalidad);
          tr.appendChild(tdEstado);
          tr.appendChild(tdAccion);
          
          fragment.appendChild(tr);
        }
        
        tbody.appendChild(fragment);
      } else {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "small";
        td.style.padding = "12px";
        td.style.textAlign = "center";
        td.textContent = "Sin resultados.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      announce(`${items.length} curso${items.length !== 1 ? 's' : ''}`);
    }

    // ═══════════════════════════════════════════════════════════════
    // CARGA DESDE /data/cursos.tsv
    // ═══════════════════════════════════════════════════════════════
    const DATA_URL = "/data/cursos.tsv";

    function stripBOM(s) {
      return s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
    }

    function detectDelimiter(text) {
      const sample = text.split(/\r?\n/).slice(0, 5).join("\n");
      const tabs = (sample.match(/\t/g) || []).length;
      const semis = (sample.match(/;/g) || []).length;
      const commas = (sample.match(/,/g) || []).length;
      if (tabs >= semis && tabs >= commas) return "\t";
      if (semis >= commas) return ";";
      return ",";
    }

    function toISODate(raw) {
      const v = String(raw || "").trim();
      if (!v) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
      const m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        const dd = String(m[1]).padStart(2, "0");
        const mm = String(m[2]).padStart(2, "0");
        const yy = m[3];
        return `${yy}-${mm}-${dd}`;
      }
      return v;
    }

    function safeURL(u) {
      const v = String(u || "").trim();
      if (!v) return "#";
      try {
        if (v.startsWith("/")) return v;
        const url = new URL(v);
        return url.toString();
      } catch {
        return "#";
      }
    }

    function parseDelimited(text, delimiter) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"') {
          if (inQuotes && next === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }

        if (ch === delimiter && !inQuotes) {
          row.push(cur);
          cur = "";
          continue;
        }

        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          if (row.some(c => String(c).trim() !== "")) rows.push(row.map(c => String(c).trim()));
          row = [];
          cur = "";
          continue;
        }

        cur += ch;
      }

      if (cur.length || row.length) {
        row.push(cur);
        if (row.some(c => String(c).trim() !== "")) rows.push(row.map(c => String(c).trim()));
      }

      return rows;
    }

    function mapStatus(raw) {
      const s = String(raw || "").trim().toLowerCase();
      if (s.includes("abierto") || s === "open") return "open";
      if (s.includes("espera") || s === "wait") return "wait";
      if (s.includes("cerr") || s === "closed") return "closed";
      return "open";
    }

    async function loadCoursesFromTSV() {
      const loadingOverlay = $("#loadingOverlay");
      const moduleEl = $(".module");
      
      loadingOverlay.classList.add("active");
      if (moduleEl) moduleEl.setAttribute("aria-busy", "true");
      setControlsDisabled(true);
      announce("Cargando cursos…");

      try {
        const res = await fetch(`${DATA_URL}?v=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        let text = stripBOM(await res.text());
        const delim = detectDelimiter(text);
        const rows = parseDelimited(text, delim);

        if (rows.length < 2) throw new Error("Sin filas suficientes");

        const header = rows.shift().map(h => normalize(h));
        const idx = (cands) => {
          for (const n of cands) {
            const i = header.indexOf(normalize(n));
            if (i >= 0) return i;
          }
          return -1;
        };

        const iId = idx(["id", "ref", "referencia"]);
        const iTitle = idx(["titulo", "title", "curso"]);
        const iCat = idx(["categoria", "category", "familia"]);
        const iMod = idx(["modalidad", "modality"]);
        const iStart = idx(["inicio", "startdate", "fecha_inicio", "fecha inicio"]);
        const iStatus = idx(["estado", "status"]);
        const iUrl = idx(["url", "enlace", "link"]);
        const iInfo = idx(["info", "descripcion", "desc", "observaciones"]);
        const iHours = idx(["horas", "hours", "duracion", "duración"]);
        const iUpdated = idx(["actualizado", "updated", "last_update", "ultima_actualizacion"]);

        if (iTitle < 0 || iCat < 0 || iStart < 0) {
          throw new Error("Faltan columnas obligatorias (titulo,categoria,inicio)");
        }

        const mapped = [];
        let updatedValue = "";
        const seenIds = new Set();

        for (const r of rows) {
          const title = (r[iTitle] || "").trim();
          if (!title) continue;

          const id = iId >= 0 ? (r[iId] || "").trim() : "";
          
          if (id && seenIds.has(id)) {
            console.warn(`⚠️ ID duplicado ignorado: ${id}`);
            continue;
          }
          if (id) seenIds.add(id);

          const startISO = toISODate(r[iStart]);
          const status = mapStatus(iStatus >= 0 ? r[iStatus] : "");
          const rawModality = iMod >= 0 ? r[iMod] : "";
          const rawCategory = (iCat >= 0 ? r[iCat] : "").trim();
          const category = titleCaseEs(rawCategory);

          if (!updatedValue && iUpdated >= 0) updatedValue = (r[iUpdated] || "").trim();

          const modality = normalizeModality(rawModality);
          const info = (iInfo >= 0 ? r[iInfo] : "").trim() || "";
          
          const haystack = normalize(`${title} ${category} ${modality} ${id} ${info}`);

          mapped.push({
            id,
            title,
            category,
            modality,
            startDate: startISO,
            status,
            url: safeURL(iUrl >= 0 ? r[iUrl] : ""),
            info,
            hours: (iHours >= 0 ? Number(String(r[iHours] || "").replace(",", ".").trim()) : 0) || 0,
            _haystack: haystack
          });
        }

        if (!mapped.length) throw new Error("No hay cursos válidos");

        COURSES = mapped;

        UPDATED_AT = updatedValue
          ? updatedValue
          : new Date().toLocaleString("es-ES", {
              year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"
            });

        state.cat = ""; state.mod = ""; state.q = ""; state.chip = "";

        render();
        announce(`Cursos actualizados. ${mapped.length} resultados.`);
        
      } catch (err) {
        console.warn("No se pudo cargar TSV:", err);
        announce("Listado no disponible temporalmente. Mostrando datos de prueba.");
        render();
        
      } finally {
        loadingOverlay.classList.remove("active");
        if (moduleEl) moduleEl.setAttribute("aria-busy", "false");
        setControlsDisabled(false);
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // CONTROLES
    // ═══════════════════════════════════════════════════════════════
    const debouncedSearch = debounce((value) => {
      state.q = normalize(value);
      render();
    }, 150);
    
    $("#q").addEventListener("input", e => debouncedSearch(e.target.value));
    $("#cat").addEventListener("change", e => { state.cat = e.target.value; render(); });
    $("#mod").addEventListener("change", e => { state.mod = e.target.value; render(); });
    $("#sort").addEventListener("change", e => { state.sort = e.target.value; render(); });
    $("#upcoming").addEventListener("change", e => { state.upcoming = (e.target.value === "1"); render(); });
    $("#toggleView").addEventListener("click", () => { 
      state.view = (state.view === "cards") ? "table" : "cards"; 
      render(); 
      requestAnimationFrame(focusFirstInView);
    });

    // LIMPIAR FILTROS
    $("#clearFilters").addEventListener("click", () => {
      state.q = "";
      state.cat = "";
      state.mod = "";
      state.chip = "";
      state.upcoming = true;
      $("#q").value = "";
      $("#cat").value = "";
      $("#mod").value = "";
      $("#upcoming").value = "1";
      render();
      showToast("Filtros limpiados", "success");
    });

    // LIMPIAR CHIP
    $("#clearChip").addEventListener("click", () => {
      state.chip = "";
      render();
    });

    // ═══════════════════════════════════════════════════════════════
    // IMPORTACIÓN MANUAL
    // ═══════════════════════════════════════════════════════════════
    if (ADMIN_MODE) {
      $("#csvFile").addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        await importFile(file);
        e.target.value = "";
      });

      const dropZone = $("#dropZone");
      if (dropZone) {
        dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.background = "#eef2ff"; });
        dropZone.addEventListener("dragleave", () => { dropZone.style.background = "var(--bg-tertiary)"; });
        dropZone.addEventListener("drop", async (e) => {
          e.preventDefault();
          dropZone.style.background = "var(--bg-tertiary)";
          const file = e.dataTransfer.files?.[0];
          if (file) await importFile(file);
        });
        dropZone.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); $("#csvFile").click(); }
        });
      }

      $("#downloadTemplate")?.addEventListener("click", () => {
        const template = `id\ttitulo\tcategoria\tmodalidad\tinicio\testado\turl\tinfo\thoras\nCURSO-001\tMarketing Digital\tComercio y Marketing\tOnline\t2026-03-16\tabierto\thttps://ejemplo.com\tMarketing online\t40\nCURSO-002\tLogística\tTransporte\tPresencial\t2026-04-01\tespera\thttps://ejemplo.com\tGestión almacenes\t60`;

        const blob = new Blob([template], { type: "text/tab-separated-values;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "plantilla-cursos.tsv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      });
    }

    async function importFile(file) {
      try {
        const text = await file.text();
        const delimiter = file.name.toLowerCase().endsWith('.tsv') ? '\t' : detectDelimiter(text);
        const rows = parseDelimited(stripBOM(text), delimiter);
        
        if (rows.length < 2) {
          showToast("El archivo debe tener encabezados y datos", "error");
          return;
        }

        const header = rows.shift().map(h => normalize(h));

        const idx = (cands) => {
          for (const n of cands) {
            const i = header.indexOf(normalize(n));
            if (i >= 0) return i;
          }
          return -1;
        };

        const iId = idx(["id", "ref"]);
        const iTitle = idx(["titulo", "title", "curso"]);
        const iCat = idx(["categoria", "category"]);
        const iMod = idx(["modalidad", "modality"]);
        const iStart = idx(["inicio", "startdate", "start"]);
        const iStatus = idx(["estado", "status"]);
        const iUrl = idx(["url", "link"]);
        const iInfo = idx(["info", "descripcion", "desc"]);
        const iHours = idx(["horas", "hours"]);

        if (iTitle < 0 || iCat < 0 || iStart < 0) {
          showToast("Faltan campos obligatorios: titulo, categoria, inicio", "error");
          return;
        }

        const mapped = [];
        const seenIds = new Set();
        
        for (const r of rows) {
          if (!r.length) continue;
          const title = r[iTitle]?.trim();
          if (!title) continue;

          const id = iId >= 0 ? (r[iId]?.trim() || "") : "";
          if (id && seenIds.has(id)) continue;
          if (id) seenIds.add(id);

          const status = mapStatus(iStatus >= 0 ? r[iStatus] : "");
          const rawModality = iMod >= 0 ? r[iMod] : "";
          const rawCategory = (iCat >= 0 ? r[iCat] : "").trim();
          const category = titleCaseEs(rawCategory);
          const modality = normalizeModality(rawModality);
          const info = (iInfo >= 0 ? r[iInfo] : "").trim() || "";
          
          const haystack = normalize(`${title} ${category} ${modality} ${id} ${info}`);

          mapped.push({
            id,
            title,
            category,
            modality,
            startDate: toISODate(iStart >= 0 ? r[iStart] : ""),
            status,
            url: safeURL(iUrl >= 0 ? r[iUrl] : ""),
            info,
            hours: (iHours >= 0 ? Number((r[iHours] || "").trim()) : 0) || 0,
            _haystack: haystack
          });
        }

        if (!mapped.length) {
          showToast("Sin cursos válidos en el archivo", "error");
          return;
        }

        COURSES = mapped;
        UPDATED_AT = new Date().toLocaleString("es-ES", {
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
        
        state.cat = ""; state.mod = ""; state.q = ""; state.chip = "";
        render();
        
        showToast(`Importado: ${mapped.length} curso${mapped.length !== 1 ? 's' : ''}`, "success");
        
      } catch (error) {
        console.error("Error:", error);
        showToast("Error al procesar archivo. Verifica formato CSV/TSV", "error");
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // NOTICE TOGGLE
    // ═══════════════════════════════════════════════════════════════
    const toggleNoticeBtn = $("#toggleNotice");
    const noticeDetails = $("#noticeDetails");
    
    if (toggleNoticeBtn && noticeDetails) {
      toggleNoticeBtn.addEventListener("click", () => {
        const isExpanded = toggleNoticeBtn.getAttribute("aria-expanded") === "true";
        
        if (isExpanded) {
          noticeDetails.classList.add("hidden");
          toggleNoticeBtn.setAttribute("aria-expanded", "false");
        } else {
          noticeDetails.classList.remove("hidden");
          toggleNoticeBtn.setAttribute("aria-expanded", "true");
          announce("Información adicional desplegada");
        }
      });
    }

    // ═══════════════════════════════════════════════════════════════
    // INICIALIZACIÓN
    // ═══════════════════════════════════════════════════════════════
    loadCoursesFromTSV();
  </script>

  <footer class="hero-banner">
    <img src="https://herrerahoy.es/img/comunidad/cursos/banner_cursos.png" 
         alt="Logos institucionales: FSE+, SEPE, Ministerio de Trabajo - Financiado por la Unión Europea" 
         class="hero-image" />
  </footer>

</body>
</html>
